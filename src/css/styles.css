:root {
    /* Colors - Light Mode (Default) */
    --primary-blue: #36c5f0;
    --primary-red: #f13f83;
    --text-primary: #333;
    --text-secondary: #555;
    --text-muted: #666;
    --bg-white: #fff;
    --bg-white-transparent: rgba(255, 255, 255, 0.8);
    --bg-overlay: rgba(255, 255, 255, 0.8);
    --border-light: rgba(0, 0, 0, 0.1);
    --shadow-light: rgba(0, 0, 0, 0.2);
    --shadow-medium: rgba(0, 0, 0, 0.5);
    --stripe-color: rgba(235, 235, 235, 0.4);
    --link-color: #443dff;
    
    /* Layout */
    --pin-size: 30px;
    --legend-icon-size: 18px;
    --font-family: 'Noto Sans TC', Arial, Helvetica, sans-serif;
    --border-radius: 5px;

    /* Cluster Colors */
    --cluster-blue-bg: rgba(54, 197, 240, 0.4);
    --cluster-blue-inner: rgba(54, 197, 240, 0.9);
    --cluster-red-bg: rgba(241, 63, 131, 0.4);
    --cluster-red-inner: rgba(241, 63, 131, 0.9);
}

@media (prefers-color-scheme: dark) {
    :root {
        /* Colors - Dark Mode */
        --text-primary: #eee;
        --text-secondary: #ccc;
        --text-muted: #aaa;
        --bg-white: #222;
        --bg-white-transparent: rgba(30, 30, 30, 0.9);
        --bg-overlay: rgba(0, 0, 0, 0.8);
        --border-light: rgba(255, 255, 255, 0.1);
        --shadow-light: rgba(0, 0, 0, 0.5);
        --shadow-medium: rgba(0, 0, 0, 0.8);
        --link-color: #8ab4f8;
        --stripe-color: rgba(255, 255, 255, 0.2);
    }
}

body {
    margin: 0;
    padding: 0;
    font-family: var(--font-family);
    background-color: var(--bg-white);
    color: var(--text-primary);
}

#map {
    width: 100%;
    height: 100vh;
    height: 100dvh; /* Adapt to dynamic mobile browser viewports */
    background-color: #e5e5e5; /* Fallback for map loading */
}

/* Dark mode map filter */
@media (prefers-color-scheme: dark) {
    .leaflet-tile-pane {
        filter: invert(1) hue-rotate(180deg) brightness(0.95) contrast(0.9);
    }
    /* Invert back markers and controls so they look normal */
    .leaflet-marker-pane,
    .leaflet-overlay-pane,
    .leaflet-popup-pane,
    .leaflet-control-container {
        /* Usually we don't invert these, but since the whole map container isn't inverted, just the tiles, this is fine. 
           If we inverted the whole map div, we would need to un-invert these.
           Wait, leaflet-tile-pane is just the tiles. So markers are on top and not inverted.
           However, CartoDB tiles are light. Inverting them makes them dark.
        */
    }
}

/* Fix for mobile browser safe areas to prevent cropping */
.leaflet-bottom .leaflet-control,
.leaflet-container .leaflet-control-attribution {
    margin-bottom: max(10px, env(safe-area-inset-bottom));
}

.leaflet-container .leaflet-control-attribution {
    margin-right: 10px;
    background: var(--bg-white-transparent) !important;
    color: var(--text-secondary);
}

.leaflet-container .leaflet-control-attribution a {
    color: var(--text-secondary);
}

/* --- Popups --- */
.store-popup {
    font-size: 14px;
    color: var(--text-primary);
}

.store-popup b {
    font-size: 16px;
    color: var(--text-primary);
}

.store-popup-link {
    text-decoration: none;
    color: var(--link-color) !important;
    border-bottom: 1px solid var(--link-color);
}

.store-popup-flavor {
    font-weight: bold;
    white-space: nowrap;
}

.store-popup-flavor--multiline {
    white-space: normal;
}

/* Leaflet Popup Styling Override for Dark Mode */
.leaflet-popup-content-wrapper, .leaflet-popup-tip {
    background: var(--bg-white);
    color: var(--text-primary);
}

/* --- Legend --- */
.legend {
    padding: 6px 8px;
    background: var(--bg-white-transparent);
    box-shadow: 0 0 15px var(--shadow-light);
    border-radius: var(--border-radius);
    line-height: 24px;
    color: var(--text-secondary);
    font-size: 14px;
}

.legend i {
    width: var(--legend-icon-size);
    height: var(--legend-icon-size);
    float: left;
    margin-right: 8px;
    opacity: 0.9;
    border-radius: 50%;
    border: 1px solid var(--border-light);
}

/* Rotate striped icons in legend to match map "X" pattern */
.legend .marker-blue-striped,
.legend .marker-red-striped {
    transform: rotate(45deg);
}

.legend-item {
    display: flex;
    align-items: center;
    margin-top: 5px;
}

.last-updated {
    margin-top: 8px;
    font-size: 12px;
    color: var(--text-muted);
    border-top: 1px solid var(--border-light);
    padding-top: 4px;
}

/* --- Map Pin Shapes --- */
.custom-pin {
    width: var(--pin-size);
    height: var(--pin-size);
    border-radius: 50% 50% 50% 0;
    transform: rotate(-45deg);
    border: 2px solid var(--bg-white);
    box-shadow: -1px 1px 5px var(--shadow-medium);
    box-sizing: border-box; 
    display: flex;
    justify-content: center;
    align-items: center;
}

.custom-pin::after {
    content: '';
    width: 12px;
    height: 12px;
    background-color: var(--bg-white);
    border-radius: 50%;
}

/* Color Variants */
.marker-blue,
.marker-blue-striped {
    background-color: var(--primary-blue);
}

.marker-red,
.marker-red-striped {
    background-color: var(--primary-red);
}

/* Striped Variants (Grid Pattern) */
.marker-blue-striped,
.marker-red-striped {
    background-image: 
        repeating-linear-gradient(
            0deg,
            var(--stripe-color) 0px,
            var(--stripe-color) 2px,
            transparent 2px,
            transparent 6px
        ),
        repeating-linear-gradient(
            90deg,
            var(--stripe-color) 0px,
            var(--stripe-color) 2px,
            transparent 2px,
            transparent 6px
        );
}

/* --- Controls --- */
.leaflet-control-locate {
    background-color: var(--bg-white-transparent);
    border: 2px solid var(--shadow-light);
    background-clip: padding-box;
    border-radius: 4px;
    cursor: pointer;
    width: 34px;
    height: 34px;
    display: flex;
    justify-content: center;
    align-items: center;
    box-shadow: 0 1px 5px rgba(0,0,0,0.65);
}

.leaflet-control-locate:hover {
    background-color: var(--bg-white); /* Slightly more opaque on hover */
}

.leaflet-control-locate-icon {
    width: 20px;
    height: 20px;
    /* Use mask to allow color change via background-color */
    -webkit-mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath d='M256 0c141.4 0 256 114.6 256 256S397.4 512 256 512 0 397.4 0 256 114.6 0 256 0zm0 48C141.1 48 48 141.1 48 256s93.1 208 208 208 208-93.1 208-208S370.9 48 256 48zm0 96c61.9 0 112 50.1 112 112s-50.1 112-112 112-112-50.1-112-112 50.1-112 112-112zm0 48c-35.3 0-64 28.7-64 64s28.7 64 64 64 64-28.7 64-64-28.7-64-64-64z'/%3E%3C/svg%3E") no-repeat center;
    mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath d='M256 0c141.4 0 256 114.6 256 256S397.4 512 256 512 0 397.4 0 256 114.6 0 256 0zm0 48C141.1 48 48 141.1 48 256s93.1 208 208 208 208-93.1 208-208S370.9 48 256 48zm0 96c61.9 0 112 50.1 112 112s-50.1 112-112 112-112-50.1-112-112 50.1-112 112-112zm0 48c-35.3 0-64 28.7-64 64s28.7 64 64 64 64-28.7 64-64-28.7-64-64-64z'/%3E%3C/svg%3E") no-repeat center;
    background-color: var(--text-primary);
}

/* Loading State for Locate Control */
.leaflet-control-locate.loading {
    cursor: wait;
    pointer-events: none;
}

.leaflet-control-locate.loading .leaflet-control-locate-icon {
    -webkit-mask: none;
    mask: none;
    background-image: none; /* Hide the icon */
    background-color: transparent;
    border: 2px solid var(--border-light);
    border-top: 2px solid var(--text-secondary);
    border-radius: 50%;
    width: 14px;
    height: 14px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* --- User Location --- */
.user-location-marker {
    background: transparent;
    border: none;
}

.pulse {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #4285F4;
    border: 3px solid var(--bg-white);
    box-shadow: 0 0 5px rgba(0,0,0,0.3);
    position: relative;
    box-sizing: border-box;
}

.pulse::after {
    content: "";
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: rgba(66, 133, 244, 0.5);
    position: absolute;
    top: 0;
    left: 0;
    animation: pulse-animation 2s infinite;
}

@keyframes pulse-animation {
    0% {
        transform: scale(1);
        opacity: 0.8;
    }
    70% {
        transform: scale(3);
        opacity: 0;
    }
    100% {
        transform: scale(1);
        opacity: 0;
    }
}

/* --- Loading Overlay --- */
#loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--bg-overlay);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    opacity: 1;
    transition: opacity 0.3s ease;
}

#loading-overlay.hidden {
    opacity: 0;
    pointer-events: none;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid var(--border-light);
    border-top: 4px solid var(--primary-blue);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

/* --- Toast Notifications --- */
#toast-container {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10000;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    width: 90%;
    max-width: 400px;
    pointer-events: none;
}

.toast {
    background-color: #333;
    color: #fff;
    padding: 12px 20px;
    border-radius: 4px;
    font-size: 14px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.3s ease;
    pointer-events: auto;
    text-align: center;
}

.toast.show {
    opacity: 1;
    transform: translateY(0);
}

.toast.error {
    background-color: #e53935;
}

/* --- Marker Cluster Customization --- */
.marker-cluster {
    background-clip: padding-box;
    border-radius: 20px;
}

.marker-cluster div {
    width: 30px;
    height: 30px;
    margin-left: 5px;
    margin-top: 5px;
    text-align: center;
    border-radius: 15px;
    font: 12px "Helvetica Neue", Arial, Helvetica, sans-serif;
    color: white;
    font-weight: bold;
    display: flex;
    justify-content: center;
    align-items: center;
}

/* Default Blue Cluster (Majority Single) */
.marker-cluster-blue {
    background-color: var(--cluster-blue-bg);
}

.marker-cluster-blue div {
    background-color: var(--cluster-blue-inner);
}

/* Red Cluster (Majority Dual) */
.marker-cluster-red {
    background-color: var(--cluster-red-bg);
}

.marker-cluster-red div {
    background-color: var(--cluster-red-inner);
}

/* Split Cluster (Equal Quantities) */
.marker-cluster-split {
    background: linear-gradient(to right, var(--cluster-red-bg) 50%, var(--cluster-blue-bg) 50%);
}

.marker-cluster-split div {
    background: linear-gradient(to right, var(--cluster-red-inner) 50%, var(--cluster-blue-inner) 50%);
}
